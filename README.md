# 价值策略因子选股 回测 (Backtrader + Wind)

## 目标
依据因子文件 `价值策略因子数据【CSV】.csv`：
1. 回测区间 2015-01-01 至 2025-08-26，2015-01-01 为初始建仓日。
2. 每年 12 月底调仓（以因子数据中当年 12 月最后一个交易日为调仓日）。
3. 因子: 现金流量比例、股息率、回购比例，各自排名后等权求和，选得分最优前 30 只股票，构建等权组合。
4. 单边交易成本 0.2%。
5. 调仓日使用上一交易日前复权收盘价进行权重计算与下单。
6. 基准指数：`881005.WI`。
7. 前复权收盘价及基准数据来自 Wind，需要 WindPy 环境并在全局启动。
8. 使用 Backtrader 进行回测。

## 项目结构
```
requirements.txt
factor_loader.py        # 加载/处理因子数据，选股及调仓日期计算
wind_data.py            # Wind 数据抓取函数 (价格 & 基准)
strategy.py             # Backtrader 策略逻辑 (年度调仓 + 等权分配)
main.py                 # 回测入口脚本
价值策略因子数据【CSV】.csv  # 因子原始数据
README.md
cache_prices/           # Wind 拉取后本地缓存价格CSV
equity_curve.png        # 回测生成的净值曲线图（运行后出现）
```

## 环境准备
```powershell
# 创建虚拟环境 (可选)
python -m venv .venv; .\.venv\Scripts\activate

# 安装依赖
pip install -r requirements.txt
```

确保拥有 Wind 客户端并已登录；若命令行运行需要保持 Wind 终端开启。

## Wind 登录 (若未自动连接)
在运行脚本前可手动调用:
```python
from WindPy import w
w.start()
print(w.isconnected())
```

## 运行回测
```powershell
python main.py
```

运行结束后将在当前目录生成 `equity_curve.png`，并在控制台输出：最终组合净值、最大回撤、夏普比率等指标。

## 关键逻辑说明
- `compute_rebalance_dates`: 对每年筛选 12 月份因子数据中的最后日期。
- `select_portfolio`: 对调仓日的 3 因子做降序排名，排名值相加后取最小(综合排名最高)的前 30。
- 策略在调仓日取上一交易日收盘价估算下单股数 (前复权价)。
- 手续费: `commission=0.002` 代表单边 0.2%。

## 可扩展方向
- 增加异常值/缺失值处理 (目前假设数据完整)。
- 加入风险控制 (最大单票权重限制、市值过滤)。
- 记录基准指数净值以计算超额收益。
- 输出绩效指标：年化收益、最大回撤、夏普等 (可自定义分析器)。
- 增加缓存有效期策略、自动增量更新 (目前为整区间简单缓存)。
- 增加日志与交易明细保存 CSV。

## 注意事项
- CSV 中的港股代码为四位形式如 `0001.HK`，Wind 可能需要 `00001.HK`，在 `factor_loader.standardize_code` 已自动补齐。
- 若 Wind 返回错误，请核对证券是否退市或权限问题；退市股票在后续期间可能无价格数据，会被自动忽略。
- 回测结果仅供策略初步验证，真实交易需考虑流动性、停牌、除权等细节。

## 后续改进建议
1. 缓存 Wind 拉取的日线数据 (避免重复请求)。
2. 使用 `bt.Analyzer` 添加绩效指标输出。
3. 与基准比较时增加净值曲线绘图。
4. 支持再平衡日的部分换仓 (减低交易成本)。

---
如需新增绩效指标或绘图，请告知。